# openresty-existdb

 A TLS setup for openresty/nginx as reverse proxy for eXistdb

This repo is based on a previous one grantmacken/nginx-exist

I wanted to 
 - enable HTTPS by default
 - explore openresty/lua middleware capability

## Openresty

I want to automate the install of the latest openresty,
with ssl enabled

### `make dl`

Check for latest versions of
 -  openresty
 -  pcre
 -  openssl
 -  zlib

and download newest version

### `make orInstall`

with latest versions compile and install openresty

check the configure directives first

## Openresty Package Management

The next version of openresty will use its own package manager,
 in the meantime use luarocks

note luajit version is hardwired

`make luarocksLatest`

`make luarocksInstall`

TODO!


## Setting Up Serving HTTPS by default

TODO!

## 
 
### Development Make Targets

`make orDev` Run this when 
1. changes are made to src files in 'openresty/nginx/conf/' or
2. changes made to the dynamicaly generated 'nginx.conf' in the make file 'includes/nginx-conf.mk' or
3. new src lua files are added to 'openresty/site/lualib'
 
When`make orDev` is run  
1. the development nginx.conf is generated by `make` and placed directly into
   `/usr/local/openresty/nginx/conf/` 
2. src files and folders are symlinked to '/usr/local/openresty'  using `stow`
3. the main 'ngnix.conf' is tested and reloaded

NOTES: The nginx.conf generated by  orDev will add the directive `lua_code_cache off;`.  With this off any changes to lua scripts will not require a nginx reload.  

`make ngDH` - creates the 1024 bit Diffie-Hellman Parameter 

## src dirs/files in this repo

- openresty
  - nginx
    - conf: user created nginx 'include' conf files
            any files here are symlinked to  /usr/local/openresty/nginx/conf/
    - ssl:  the dh-param.pem file generated via `make ngDH`
  - site
    - lualib: user created lua files
              any files here are symlinked to  /usr/local/openresty/site/lualib
              Placing lua files here, the lau scripts will be in 'package.path'
              foo.lua + and bar.lua from https://openresty.org/en/using-luarocks.html 
              are here to check if luarocks is working ok
              any files here are symlinked to  /usr/local/openresty/site/lualib

---

# Luarocks

  TODO!

